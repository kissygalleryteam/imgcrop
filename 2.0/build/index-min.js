/*! imgcrop - v2.0 - 2013-05-04 7:08:15 PM
* Copyright (c) 2013 元泉; Licensed  */
KISSY.add("gallery/imgcrop/2.0/type/html5/preview",function(t){function i(){i.superclass.constructor.apply(this,arguments),this.canvas=e("<canvas>"),this.ctx=this.canvas[0].getContext("2d"),this.container=e(this.get("previewEl")),this._init()}var e=t.all;return i.ATTRS={previewEl:{value:""},viewHeight:{value:300},viewWidth:{value:300},image:{value:null}},t.extend(i,t.Base,{_init:function(){this._build()},_build:function(){var t=this,i=t.get("viewWidth"),e=t.get("viewHeight");t.container.css({position:"relative",width:i||t.container.width(),height:e||t.container.height()}),t.container.html("").append(t.canvas.css({position:"absolute"})),t._rejustSize()},_rejustSize:function(){var t,i,e=this,s=e.get("image"),h=e.get("viewWidth"),n=e.get("viewHeight"),a=s.width,o=s.height;a/h>o/n?(t=Math.min(h,a),i=t*o/a):(i=Math.min(n,o),t=i*a/o),e.canvas[0].width=e.canvasW=Math.floor(t),e.canvas[0].height=e.canvasH=Math.floor(i),e.canvas.css({top:(e.container.height()-e.canvasH)/2,left:(e.container.width()-e.canvasW)/2})},draw:function(t,i,e,s,h){var n=this;n.ctx.clearRect(0,0,n.canvasW,n.canvasH);var a=n.get("image"),o=Math.floor(e*h*n.canvasW/a.width),r=Math.floor(s*h*n.canvasH/a.height);n.ctx.drawImage(a,Math.floor(t*h),Math.floor(i*h),Math.floor(e*h),Math.floor(s*h),0,0,o,r)},destroy:function(){this.canvas.remove()}}),i},{attach:!1}),KISSY.add("gallery/imgcrop/2.0/type/html5/selection",function(t){function e(){e.superclass.constructor.apply(this,arguments),this.csize=4,this.bDrag=[!1,!1,!1,!1],this.bDragAll=!1}return e.ATTRS={x:{value:0},y:{value:0},w:{value:50},h:{value:50},ratio:{value:!1},minWidth:{value:50},minHeight:{value:50},resizable:{value:!0},borderColor:{value:"#fff"},cubesColor:{value:"#fff"},constraint:{value:[1e4,1e4]}},t.extend(e,t.Base,{event:{DRAG:"drag",START_DRAG:"startdrag",END_DRAG:"enddrag",RESIZE:"resize",START_RESIZE:"startresize",END_RESIZE:"endresize"},draw:function(t,i){var e=this,s=t.canvas.width,h=t.canvas.height;t.clearRect(0,0,s,h),t.drawImage(i,0,0,s,h),t.strokeStyle=e.get("borderColor"),t.lineWidth=1;var n={x:Math.max(e.get("x"),0),y:Math.max(e.get("y"),0),w:Math.min(Math.max(e.get("w"),e.get("minWidth")),s),h:Math.min(Math.max(e.get("h"),e.get("minHeight")),h)};e.set(n),t.strokeRect(n.x,n.y,n.w,n.h),t.fillStyle="rgba(0, 0, 0, 0.5)",t.fillRect(0,0,s,e.get("y")),t.fillRect(0,e.get("y"),e.get("x"),e.get("h")),t.fillRect(e.get("x")+e.get("w"),e.get("y"),s-e.get("x")-e.get("w"),e.get("h")),t.fillRect(0,e.get("y")+e.get("h"),s,h-e.get("y")-e.get("h")),t.canvas.style.cursor=e.cursor,e.get("resizable")&&(t.fillStyle=e.get("cubesColor"),t.fillRect(e.get("x")-e.csize,e.get("y")-e.csize,2*e.csize,2*e.csize),t.fillRect(e.get("x")+e.get("w")-e.csize,e.get("y")-e.csize,2*e.csize,2*e.csize),t.fillRect(e.get("x")+e.get("w")-e.csize,e.get("y")+e.get("h")-e.csize,2*e.csize,2*e.csize),t.fillRect(e.get("x")-e.csize,e.get("y")+e.get("h")-e.csize,2*e.csize,2*e.csize))},getInfo:function(){return{x:this.get("x"),y:this.get("y"),w:this.get("w"),h:this.get("h")}},resize:function(t,i){var e,s,h,n,a=this;a.bDrag[0]?(h=t,n=i,e=a.get("w")+a.get("x")-t,s=a.get("h")+a.get("y")-i):a.bDrag[1]?(h=a.get("x"),n=i,e=t-a.get("x"),s=a.get("h")+a.get("y")-i):a.bDrag[2]?(h=a.get("x"),n=a.get("y"),e=t-a.get("x"),s=i-a.get("y")):a.bDrag[3]&&(h=t,n=a.get("y"),e=a.get("w")+a.get("x")-t,s=i-a.get("y")),a.get("ratio")&&(s=e*a.get("h")/a.get("w")),a.set({w:e,x:h,h:s,y:n}),a.fire(a.event.RESIZE)},move:function(t,i){var e=this;e.set({x:Math.min(Math.max(e.get("px")+t,0),e.get("constraint")[0]-e.get("w")),y:Math.min(Math.max(e.get("py")+i,0),e.get("constraint")[1]-e.get("h"))}),e.fire(e.event.DRAG)},registerPointPos:function(t,i){var e=this,s=-1;return t>e.get("x")+e.csize&&e.get("x")+e.get("w")-e.csize>t&&i>e.get("y")+e.csize&&e.get("y")+e.get("h")-e.csize>i&&(s=0),t>e.get("x")-e.csize&&e.get("x")+e.csize>t&&i>e.get("y")-e.csize&&e.get("y")+e.csize>i?s=1:t>e.get("x")+e.get("w")-e.csize&&e.get("x")+e.get("w")+e.csize>t&&i>e.get("y")-e.csize&&e.get("y")+e.csize>i?s=2:t>e.get("x")+e.get("w")-e.csize&&e.get("x")+e.get("w")+e.csize>t&&i>e.get("y")+e.get("h")-e.csize&&e.get("y")+e.get("h")+e.csize>i?s=3:t>e.get("x")-e.csize&&e.get("x")+e.csize>t&&i>e.get("y")+e.get("h")-e.csize&&e.get("y")+e.get("h")+e.csize>i&&(s=4),s},markByCode:function(t){var i=this;-1!==t&&(0===t?(i.bDragAll=!0,i.fire(i.event.START_DRAG)):(i.bDrag[t-1]=!0,i.fire(i.event.START_RESIZE)))},hoverByCode:function(t){var i=this;switch(t){case 0:i.cursor="move";break;case 1:case 3:i.cursor="nw-resize";break;case 2:case 4:i.cursor="ne-resize";break;default:i.cursor="default"}},canMove:function(){return this.bDragAll},canResize:function(){return t.inArray(!0,this.bDrag)},reset:function(){for(this.bDragAll=!1,i=0;this.bDrag.length>i;i++)this.bDrag[i]=!1}}),e},{attach:!1}),KISSY.add("gallery/imgcrop/2.0/type/html5/imgcrop",function(t,i,e){function s(){s.superclass.constructor.apply(this,arguments),this.container=h(this.get("areaEl")),this.canvas=h("<canvas>"),this.ctx=this.canvas[0].getContext("2d"),this.image=new Image,this.preview=null,this._init()}var h=t.all;return s.ATTRS={areaEl:{value:""},areaWidth:{value:0},areaHeight:{value:0},url:{value:""},initWidth:{value:100},initHeight:{value:100},resizable:{value:!0},ratio:{value:!1},minHeight:{value:10},minWidth:{value:10},initialXY:{value:[50,50]},borderColor:{value:"#fff"},cubesColor:{value:"#fff"},previewEl:{value:""},viewHeight:{value:100},viewWidth:{value:100},touchable:{value:!0}},t.extend(s,t.Base),t.augment(s,t.EventTarget,{event:{DRAG:"drag",START_DRAG:"startdrag",END_DRAG:"enddrag",RESIZE:"resize",START_RESIZE:"startresize",END_RESIZE:"endresize",TOUCH:"touch",START_TOUCH:"starttouch",END_TOUCH:"endtouch",PINCH:"pinch",START_PINCH:"startpinch",END_PINCH:"endpinch",IMGLOAD:"imgload"},_init:function(){var t=this,i=t.image;i.onload=function(){t._build(),t._rejustSize(i.width,i.height,t.container.width(),t.container.height()),t._createSelection(),t._drawScene(),t._bind(),t._createPreview(),t.fire(t.event.IMGLOAD,t.getOriginalSize())},i.src=t.get("url")},_bind:function(){var t=this;t.canvas.on("mousemove",t._handleHover,t),t.canvas.on("mousedown",t._handleMouseDown,t),h(document).on("mouseup",t._handleMouseUp,t),t.on("*Change",t._doAttrChange,t),t.get("touchable")&&t._bindTouch()},_unBind:function(){var t=this;h(document).detach("mousemove",t._handleMouseMove,t),t.canvas.detach("mousedown",t._handleMouseDown,t),h(document).detach("mouseup",t._handleMouseUp,t),t.detach("*Change",t._doAttrChange,t)},_doAttrChange:function(i){var e=this;t.each(i.attrName,function(t,s){var h=i.newVal[s];switch(t){case"initWidth":e.theSelection.set("w",h);break;case"initHeight":e.theSelection.set("h",h);break;case"initialXY":e.theSelection.set("x",h[0]),e.theSelection.set("y",h[1]);break;case"borderColor":case"cubesColor":case"resizable":case"minWidth":case"minHeight":case"ratio":e.theSelection.set(t,h);break;default:e.reset()}})},_createPreview:function(){var e=this;t.one(e.get("previewEl"))&&(e.preview=new i({image:e.image,previewEl:e.get("previewEl"),viewHeight:e.get("viewHeight"),viewWidth:e.get("viewWidth")}),e.on("imgload resize drag",function(){var t=e.getCropCoords();e.preview.draw(t.x,t.y,t.w,t.h,t.r)}))},_createSelection:function(){var t=this;t.theSelection=new e({x:t.get("initialXY")[0],y:t.get("initialXY")[1],w:t.get("initWidth"),h:t.get("initHeight"),minWidth:t.get("minWidth"),minHeight:t.get("minHeight"),resizable:t.get("resizable"),borderColor:t.get("borderColor"),constraint:[t.canvasW,t.canvasH],ratio:t.get("ratio")}),t.theSelection.on("*Change",function(){t._drawScene()}),t.theSelection.on("resize",function(i){t.fire(t.event.RESIZE,i)}),t.theSelection.on("startresize",function(i){t.fire(t.event.START_RESIZE,i)}),t.theSelection.on("endresize",function(i){t.fire(t.event.END_RESIZE,i)}),t.theSelection.on("drag",function(i){t.fire(t.event.DRAG,i)}),t.theSelection.on("startdrag",function(i){t.fire(t.event.START_DRAG,i)}),t.theSelection.on("enddrag",function(i){t.fire(t.event.END_DRAG,i)})},_build:function(){function t(t){return t.preventDefault(),!1}var i=this,e=i.get("areaWidth"),s=i.get("areaHeight");i.container.css({position:"relative",width:e||i.container.width(),height:s||i.container.height()}),i.canvas.detach("selectstart mousedown",t).on("selectstart mousedown",t),i.container.html("").append(i.canvas.css({position:"absolute"}))},_drawScene:function(){this.theSelection.draw(this.ctx,this.image)},_handleHover:function(t){var i=this,e=i.canvas.offset(),s=t.pageX-e.left,h=t.pageY-e.top,n=i.theSelection.registerPointPos(s,h);i.theSelection.hoverByCode(n),i._drawScene()},_handleMouseMove:function(t){var i=this;window.getSelection?window.getSelection().removeAllRanges():document.selection.empty();var e=i.canvas.offset(),s=Math.min(Math.max(t.pageX-e.left,0),i.canvasW),h=Math.min(Math.max(t.pageY-e.top,0),i.canvasH);i.theSelection.canMove()&&i.theSelection.move(s-i.iMouseX,h-i.iMouseY),i.theSelection.canResize()&&i.theSelection.resize(s,h),i._drawScene()},_handleMouseDown:function(t){var i=this,e=i.theSelection,s=i.canvas.offset(),n=i.iMouseX=t.pageX-s.left,a=i.iMouseY=t.pageY-s.top;e.set({px:e.get("x"),py:e.get("y")},{silent:!0});var o=e.registerPointPos(n,a);e.markByCode(o),h(document).on("mousemove",i._handleMouseMove,i)},_handleMouseUp:function(t){var i=this;i.theSelection.reset(),h(document).detach("mousemove",i._handleMouseMove,i),i.fire(i.event.END_DRAG,t),i.fire(i.event.END_RESIZE,t)},_bindTouch:function(){var t=this;t.canvas.on("touchstart",t._handleTouchStart,t),t.canvas.on("touchmove",t._handleTouchMove,t),t.canvas.on("touchend",t._handleTouchEnd,t),t.canvas.on("pinchStart",t._handlePinchStart,t),t.canvas.on("pinch",t._handlePinch,t),t.canvas.on("pinchEnd",t._handlePinchEnd,t)},_handleTouchStart:function(t){var i=this,e=t.targetTouches[0],s=i.theSelection,h=i.canvas.offset(),n=i.iMouseX=e.pageX-h.left,a=i.iMouseY=e.pageY-h.top;s.set({px:s.get("x"),py:s.get("y")},{silent:!0});var o=s.registerPointPos(n,a);s.markByCode(o),i.fire(i.event.START_TOUCH,t)},_handleTouchMove:function(t){var i=this;if(1==t.targetTouches.length){t.preventDefault();var e=t.targetTouches[0];i.theSelection;var s=i.canvas.offset(),h=Math.min(Math.max(e.pageX-s.left,0),i.canvasW),n=Math.min(Math.max(e.pageY-s.top,0),i.canvasH);i.theSelection.canMove()&&i.theSelection.move(h-i.iMouseX,n-i.iMouseY),i.theSelection.canResize()&&i.theSelection.resize(h,n),i._drawScene(),i.fire(i.event.TOUCH,t)}},_handleTouchEnd:function(t){this._handleMouseUp(t),this.fire(self.event.END_TOUCH,t)},_handlePinchStart:function(t){this.pinchScale=t.scale,this.cropCoords=this.getCropCoords(),this.fire(self.event.START_PINCH,t)},_handlePinch:function(t){var i=this,e=t.scale;i.cropCoords.w*e>=i.get("minWidth")&&i.cropCoords.h*e>=i.get("minHeight")&&i.setCropCoords(Math.max(i.cropCoords.x-i.cropCoords.w*(e-1)/2,0),Math.max(i.cropCoords.y-i.cropCoords.h*(e-1)/2,0),Math.min(i.cropCoords.w*e,i.canvasW),Math.min(i.cropCoords.h*e,i.canvasH)),i.fire(i.event.PINCH,t)},_handlePinchEnd:function(t){this.pinchScale=null,this.cropCoords=null,this.fire(self.event.END_TOUCH,t)},_rejustSize:function(t,i,e,s){var h,n,a=this;t/e>i/s?(h=Math.min(e,t),n=h*i/t):(n=Math.min(s,i),h=n*t/i),a.canvas[0].width=a.canvasW=Math.floor(h),a.canvas[0].height=a.canvasH=Math.floor(n),a.canvas.css({top:(a.container.height()-a.canvasH)/2,left:(a.container.width()-a.canvasW)/2})},reset:function(){this._init()},destroy:function(){this._unBind(),this.canvas.remove(),this.theSelection=null,this.preview&&this.preview.destroy()},setCropCoords:function(t,i,e,s){this.set({initialXY:[t,i],initWidth:e,initHeight:s})},getCropCoords:function(){return t.merge(this.theSelection.getInfo(),{url:this.get("url"),r:this.image.width/this.canvasW})},getOriginalSize:function(){return{width:this.image.width,height:this.image.height}},getDisplaySize:function(){return{width:this.canvasW,height:this.canvasH}},toString:function(i){return t.JSON.stringify(this.getCropCoords(),null,i||0)}}),s},{attach:!1,requires:["./preview","./selection"]}),KISSY.add("gallery/imgcrop/2.0/type/normal/resizable",function(t){function i(){this.initialize.apply(this,arguments)}var e=t.Event,s=t.DOM;return t.augment(i,{initialize:function(i,h){var n=this;this._obj=s.get(i),this._styleWidth=this._styleHeight=this._styleLeft=this._styleTop=0,this._sideRight=this._sideDown=this._sideLeft=this._sideUp=0,this._fixLeft=this._fixTop=0,this._scaleLeft=this._scaleTop=0,this._mxSet=function(){},this._mxRightWidth=this._mxDownHeight=this._mxUpHeight=this._mxLeftWidth=0,this._mxScaleWidth=this._mxScaleHeight=0,this._fun=function(){},this._borderX=parseInt(s.css(this._obj,"border-left-width"),10)+parseInt(s.css(this._obj,"border-right-width"),10),this._borderY=parseInt(s.css(this._obj,"border-top-width"),10)+parseInt(s.css(this._obj,"border-bottom-width"),10),this.setOptions(h),this.Max=!!this.options.Max,this._mxContainer=s.get(this.options.mxContainer)||null,this.mxLeft=Math.round(this.options.mxLeft),this.mxRight=Math.round(this.options.mxRight),this.mxTop=Math.round(this.options.mxTop),this.mxBottom=Math.round(this.options.mxBottom),this.Min=!!this.options.Min,this.minWidth=Math.round(this.options.minWidth),this.minHeight=Math.round(this.options.minHeight),this.Scale=!!this.options.Scale,this.Ratio=Math.max(this.options.Ratio,0),this._obj.style.position="absolute",this._mxContainer&&s.css(this._mxContainer,"position","relative"),t.each(this.options.Points,function(t,i){(function(t,i){e.on(t,"mousedown",function(t){t.funName=i,n.start(t)})})(t,i)})},setOptions:function(i){this.options={Max:!1,mxContainer:"",mxLeft:0,mxRight:9999,mxTop:0,mxBottom:9999,Min:!1,minWidth:50,minHeight:50,Scale:!1,Ratio:0,Points:{Right:".point-r",Left:".point-l",Up:".point-t",Down:".point-b",RightDown:".point-rb",LeftDown:".point-lb",RightUp:".point-rt",LeftUp:".point-lt"},onResize:function(){},onResizeStart:function(){},onResizeEnd:function(){}},t.mix(this.options,i)},start:function(t){if(t.halt(),this._fun=this[t.funName],this._styleWidth=this._obj.clientWidth,this._styleHeight=this._obj.clientHeight,this._styleLeft=this._obj.offsetLeft,this._styleTop=this._obj.offsetTop,this._sideLeft=t.clientX-this._styleWidth,this._sideRight=t.clientX+this._styleWidth,this._sideUp=t.clientY-this._styleHeight,this._sideDown=t.clientY+this._styleHeight,this._fixLeft=this._styleLeft+this._styleWidth,this._fixTop=this._styleTop+this._styleHeight,this.Scale&&(this.Ratio=this._styleWidth/this._styleHeight,this._scaleLeft=this._styleLeft+this._styleWidth/2,this._scaleTop=this._styleTop+this._styleHeight/2),this.Max){var i=this.mxLeft,s=this.mxRight,h=this.mxTop,n=this.mxBottom;this._mxContainer&&(i=Math.max(i,0),h=Math.max(h,0),s=Math.min(s,this._mxContainer.clientWidth),n=Math.min(n,this._mxContainer.clientHeight)),s=Math.max(s,i+(this.Min?this.minWidth:0)+this._borderX),n=Math.max(n,h+(this.Min?this.minHeight:0)+this._borderY),this._mxSet=function(){this._mxRightWidth=s-this._styleLeft-this._borderX,this._mxDownHeight=n-this._styleTop-this._borderY,this._mxUpHeight=Math.max(this._fixTop-h,this.Min?this.minHeight:0),this._mxLeftWidth=Math.max(this._fixLeft-i,this.Min?this.minWidth:0)},this._mxSet(),this.Scale&&(this._mxScaleWidth=2*Math.min(this._scaleLeft-i,s-this._scaleLeft-this._borderX),this._mxScaleHeight=2*Math.min(this._scaleTop-h,n-this._scaleTop-this._borderY))}e.on(document,"mousemove",this.resize,this),e.on(document,"mouseup",this.stop,this),this.options.onResizeStart(t)},stop:function(t){e.detach(document,"mousemove",this.resize,this),e.detach(document,"mouseup",this.stop,this),this.options.onResizeEnd(t)},resize:function(t){window.getSelection?window.getSelection().removeAllRanges():document.selection.empty(),this._fun(t),this._obj.style.width=this._styleWidth+"px",this._obj.style.height=this._styleHeight+"px",this._obj.style.top=this._styleTop+"px",this._obj.style.left=this._styleLeft+"px",this.options.onResize(t)},Up:function(t){this.RepairY(this._sideDown-t.clientY,this._mxUpHeight),this.RepairTop(),this.TurnDown(this.Down)},Down:function(t){this.RepairY(t.clientY-this._sideUp,this._mxDownHeight),this.TurnUp(this.Up)},Right:function(t){this.RepairX(t.clientX-this._sideLeft,this._mxRightWidth),this.TurnLeft(this.Left)},Left:function(t){this.RepairX(this._sideRight-t.clientX,this._mxLeftWidth),this.RepairLeft(),this.TurnRight(this.Right)},RightDown:function(t){this.RepairAngle(t.clientX-this._sideLeft,this._mxRightWidth,t.clientY-this._sideUp,this._mxDownHeight),this.TurnLeft(this.LeftDown)||this.TurnUp(this.RightUp)},RightUp:function(t){this.RepairAngle(t.clientX-this._sideLeft,this._mxRightWidth,this._sideDown-t.clientY,this._mxUpHeight),this.RepairTop(),this.TurnLeft(this.LeftUp)||this.TurnDown(this.RightDown)},LeftDown:function(t){this.RepairAngle(this._sideRight-t.clientX,this._mxLeftWidth,t.clientY-this._sideUp,this._mxDownHeight),this.RepairLeft(),this.TurnRight(this.RightDown)||this.TurnUp(this.LeftUp)},LeftUp:function(t){this.RepairAngle(this._sideRight-t.clientX,this._mxLeftWidth,this._sideDown-t.clientY,this._mxUpHeight),this.RepairTop(),this.RepairLeft(),this.TurnRight(this.RightUp)||this.TurnDown(this.LeftDown)},RepairX:function(t,i){if(t=this.RepairWidth(t,i),this.Scale){var e=Math.round(t/this.Ratio);if(this.Max&&e>this._mxScaleHeight)t=Math.round((e=this._mxScaleHeight)*this.Ratio);else if(this.Min&&this.minHeight>e){var s=Math.round(this.minHeight*this.Ratio);i>s&&(e=this.minHeight,t=s)}this._styleHeight=e,this._styleTop=this._scaleTop-e/2}this._styleWidth=t},RepairY:function(t,i){if(t=this.RepairHeight(t,i),this.Scale){var e=Math.round(t*this.Ratio);if(this.Max&&e>this._mxScaleWidth)t=Math.round((e=this._mxScaleWidth)/this.Ratio);else if(this.Min&&this.minWidth>e){var s=Math.round(this.minWidth/this.Ratio);i>s&&(e=this.minWidth,t=s)}this._styleWidth=e,this._styleLeft=this._scaleLeft-e/2}this._styleHeight=t},RepairAngle:function(t,i,e,s){if(t=this.RepairWidth(t,i),this.Scale){if(e=Math.round(t/this.Ratio),this.Max&&e>s)t=Math.round((e=s)*this.Ratio);else if(this.Min&&this.minHeight>e){var h=Math.round(this.minHeight*this.Ratio);i>h&&(e=this.minHeight,t=h)}}else e=this.RepairHeight(e,s);this._styleWidth=t,this._styleHeight=e},RepairTop:function(){this._styleTop=this._fixTop-this._styleHeight},RepairLeft:function(){this._styleLeft=this._fixLeft-this._styleWidth},RepairHeight:function(t,i){return t=Math.min(this.Max?i:t,t),t=Math.max(this.Min?this.minHeight:t,t,0)},RepairWidth:function(t,i){return t=Math.min(this.Max?i:t,t),t=Math.max(this.Min?this.minWidth:t,t,0)},TurnRight:function(t){return this.Min||this._styleWidth?void 0:(this._fun=t,this._sideLeft=this._sideRight,this.Max&&this._mxSet(),!0)},TurnLeft:function(t){return this.Min||this._styleWidth?void 0:(this._fun=t,this._sideRight=this._sideLeft,this._fixLeft=this._styleLeft,this.Max&&this._mxSet(),!0)},TurnUp:function(t){return this.Min||this._styleHeight?void 0:(this._fun=t,this._sideDown=this._sideUp,this._fixTop=this._styleTop,this.Max&&this._mxSet(),!0)},TurnDown:function(t){return this.Min||this._styleHeight?void 0:(this._fun=t,this._sideUp=this._sideDown,this.Max&&this._mxSet(),!0)}}),i},{attach:!1}),KISSY.add("gallery/imgcrop/2.0/type/normal/dragable",function(t){function i(){this.initialize.apply(this,arguments)}var e=t.Event,s=t.DOM;return t.UA.ie,t.augment(i,{initialize:function(t,i){this.Drag=s.get(t),this._x=this._y=0,this._marginLeft=this._marginTop=0,this.setOptions(i),this.Limit=!!this.options.Limit,this.mxLeft=parseInt(this.options.mxLeft),this.mxRight=parseInt(this.options.mxRight),this.mxTop=parseInt(this.options.mxTop),this.mxBottom=parseInt(this.options.mxBottom),this.LockX=!!this.options.LockX,this.LockY=!!this.options.LockY,this.Lock=!!this.options.Lock,this._Handle=s.get(this.options.Handle)||this.Drag,this._mxContainer=s.get(this.options.mxContainer)||null,this._Handle.style.position="absolute",this.Repair(),e.on(this._Handle,"mousedown",this.start,this)},setOptions:function(i){this.options={Handle:"",Limit:!0,mxLeft:0,mxRight:9999,mxTop:0,mxBottom:9999,mxContainer:"",LockX:!1,LockY:!1,Lock:!1,Transparent:!0,onstart:function(){},onmove:function(){},onstop:function(){}},t.mix(this.options,i)},start:function(t){t.preventDefault(),this.Lock||(this.Repair(),this._x=t.clientX-this.Drag.offsetLeft,this._y=t.clientY-this.Drag.offsetTop,this._marginLeft=parseInt(s.css(this.Drag,"margin-left"),10)||this._marginLeft,this._marginTop=parseInt(s.css(this.Drag,"margin-top"),10)||this._marginTop,e.on(document,"mousemove",this.move,this),e.on(document,"mouseup",this.stop,this),this.options.onstart(t))},stop:function(t){e.detach(document,"mousemove",this.move,this),e.detach(document,"mouseup",this.stop,this),this.options.onstop(t)},Repair:function(){this.Limit&&(this.mxRight=Math.max(this.mxRight,this.mxLeft+this.Drag.offsetWidth),this.mxBottom=Math.max(this.mxBottom,this.mxTop+this.Drag.offsetHeight),this._mxContainer&&s.css(this._mxContainer,"position","relative"))},move:function(t){if(this.Lock)return this.stop(),void 0;window.getSelection?window.getSelection().removeAllRanges():document.selection.empty();var i=t.clientX-this._x,e=t.clientY-this._y;if(this.Limit){var s=this.mxLeft,h=this.mxRight,n=this.mxTop,a=this.mxBottom;this._mxContainer&&(s=Math.max(s,0),n=Math.max(n,0),h=Math.min(h,this._mxContainer.clientWidth),a=Math.min(a,this._mxContainer.clientHeight)),i=Math.max(Math.min(i,h-this.Drag.offsetWidth),s),e=Math.max(Math.min(e,a-this.Drag.offsetHeight),n)}this.LockX||(this.Drag.style.left=i-this._marginLeft+"px"),this.LockY||(this.Drag.style.top=e-this._marginTop+"px"),this.options.onmove(t)}}),i},{attach:!1}),KISSY.add("gallery/imgcrop/2.0/type/normal/imgcrop",function(t,i,e){function s(){s.superclass.constructor.apply(this,arguments),this._init()}var h=t.all,n=t.Event,a=t.DOM;return s.ATTRS={areaEl:{value:""},areaWidth:{value:0},areaHeight:{value:0},url:{value:""},initWidth:{value:100},initHeight:{value:100},resizable:{value:!0},ratio:{value:!1},opacity:{value:50},color:{value:"#000"},minHeight:{value:100},minWidth:{value:100},previewEl:{value:""},viewHeight:{value:300},viewWidth:{value:300},initialXY:{value:[50,50]}},t.extend(s,t.Base,{_init:function(){var t=this;t._render(),t._bind()},_bind:function(){var t=this;t.on("*Change",function(){t._loadImage()}),n.on(t._tempImg,"load",t._onImgLoad,t)},_render:function(){var t=this;t.area=h(t.get("areaEl")).css("overflow","hidden").html(""),t.preview=h(t.get("previewEl")).html(""),t.area.css("position","relative"),t.wrap=h('<div class="crop-wrap">'),t.wrap.append(t._createDragEl()).appendTo(t.area),t.get("areaWidth")?t.area.width(t.get("areaWidth")):t.set("areaWidth",t.area.width()),t.get("areaHeight")?t.area.height(t.get("areaHeight")):t.set("areaHeight",t.area.height()),t._layBase=new Image,t._layCropper=new Image,t._tempImg=new Image,t.wrap.append(t._layBase).append(t._layCropper),t._setPreview(),t._loadImage()},_createDragEl:function(){var i=this,e=i.el=h('<div class="crop">');return i.get("resizable")&&t.each(["lt","t","rt","r","rb","b","lb","l"],function(t){e.append(h('<div class="crop-point point-'+t+'">'))}),e.css({position:"absolute",left:i.get("initialXY")[0],top:i.get("initialXY")[1],width:i.get("initWidth"),height:i.get("initHeight"),display:"none"}),e},_loadImage:function(){var i=this;i._layBase.style.visibility=i._layCropper.style.visibility="hidden",i._tempImg.src=i._layBase.src=i._layCropper.src=i.get("url")+"?nocache="+t.guid(),i._view&&(i._view.src=i._tempImg.src)},_onImgLoad:function(){this._initStyle(),this._setImgSize(),this._setPos(),this._initDrag(),this._initResize()},_initDrag:function(){var t=this;t._drag=new e(t.el,{Max:!0,mxContainer:t.wrap,onstart:function(i){t.fire("dragstart",i)},onmove:function(i){t._setPos(),t.fire("drag",i)},onstop:function(i){t.fire("dragend",i)}})},_initResize:function(){var t=this;t.get("resizable")&&(t._resize=new i(t.el,{Max:!0,Min:!0,Scale:t.get("ratio"),minWidth:t.get("minWidth"),minHeight:t.get("minHeight"),mxContainer:t.wrap,onResize:function(i){t._setPos(),t.fire("resize",i)},onResizeStart:function(i){t.fire("resizestart",i)},onResizeEnd:function(i){t.fire("resizeend",i)}}))},_initStyle:function(){var t=this;t.wrap.css({position:"relative",overflow:"hidden",background:t.get("color")}),t.el.css("z-index",200),a.css(t._layCropper,{zIndex:100,position:"absolute",top:0,left:0}),a.css(t._layBase,{position:"absolute",opacity:t.get("opacity")/100,top:0,left:0})},_adjustPos:function(){var t=this,i=t._getPos(),e=t.wrap.width(),s=t.wrap.height();i.x+i.w>e&&t.el.width(e-i.x),i.y+i.h>s&&t.el.height(s-i.y)},_setPos:function(){var t=this;t.el.css("zoom",.5),t.el.css({zoom:1,display:"block"}),t._adjustPos();var i=t._getPos();t._layCropper.style.clip="rect("+i.y+"px "+(i.x+i.w)+"px "+(i.y+i.h)+"px "+i.x+"px)",t._view&&t._setPrePos()},_setPreview:function(){var i=this,e=t.one(i.get("previewEl"));e&&(i._view=new Image,i._view.style.position="absolute",e.append(i._view),e.css({position:"relative",overflow:"hidden"}))},_setPrePos:function(){var t=this,i=t._getPos(),e=t._getSize(i.w,i.h,t.get("viewWidth")||a.width(preWrap),t.get("viewHeight")||a.height(preWrap)),s=e.height/i.h,h=i.y*s,n=i.x*s;a.css(t._view,{width:t._layBase.width*s,height:t._layBase.height*s,top:-h,left:-n,clip:"rect("+h+"px "+(n+e.width)+"px "+(h+e.height)+"px "+n+"px)"})},_getSize:function(t,i,e,s){var h,n,a=1*t,o=1*i;return a/e>o/s?(h=Math.min(e,a),n=h*o/a):(n=Math.min(s,o),h=n*a/o),{width:h,height:n}},_setImgSize:function(){var t=this,i=t._getSize(t._tempImg.width,t._tempImg.height,t.get("areaWidth"),t.get("areaHeight"));return t._layBase.style.width=t._layCropper.style.width=i.width+"px",t._layBase.style.height=t._layCropper.style.height=i.height+"px",t.wrap.css({position:"absolute",width:i.width,height:i.height,top:(t.area.height()-i.height)/2,left:(t.area.width()-i.width)/2}),t._layBase.style.visibility=t._layCropper.style.visibility="visible",t.fire("imgload",{width:i.width,height:i.height}),i},_getPos:function(){return{y:parseFloat(this.el.css("top")),x:parseFloat(this.el.css("left")),w:parseFloat(this.el.css("width")),h:parseFloat(this.el.css("height"))}},getDisplaySize:function(){return this._getSize(this._tempImg.width,this._tempImg.height,this.get("areaWidth"),this.get("areaHeight"))},getOriginalSize:function(){return{width:parseInt(this._tempImg.width,10),height:parseInt(this._tempImg.height,10)}},getCropCoords:function(){var t=this._getPos(),i=parseInt(this._tempImg.width,10)/parseInt(this._layBase.width,10),e={y:t.y,x:t.x,w:t.w,h:t.h,r:i,url:this.get("url")};return e},setCropCoords:function(t,i,e,s){this.el.css({width:e,height:s,top:i,left:t}),this._setPos()},show:function(){this.area.show()},hide:function(){this.area.hide()},destroy:function(){n.remove(this.area),this.area.html(""),this.preview.html("");for(var t in this)this.hasOwnProperty(t)&&delete this[t]},reset:function(){this._init()},toString:function(){return t.JSON.stringify(this.getCropCoords())}}),s},{attach:!1,requires:["./resizable","./dragable"]}),KISSY.add("gallery/imgcrop/2.0/index",function(t,i){function e(t){return new i(t)}return e},{requires:["getContext"in document.createElement("canvas")?"./type/html5/imgcrop":"./type/normal/imgcrop","./index.css"]});