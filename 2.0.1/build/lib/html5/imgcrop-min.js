KISSY.add("kg/imgcrop/2.0.1/lib/html5/imgcrop",["./preview","./selection","base","node"],function(e,t,n,i){"use strict";var a=t("./preview"),o=t("./selection"),h=t("base"),c=t("node"),s=c.all;i.exports=h.extend({initializer:function(){this.canvas=s("<canvas>"),this.ctx=this.canvas[0].getContext("2d"),this.image=new Image},event:{DRAG:"drag",START_DRAG:"startdrag",END_DRAG:"enddrag",RESIZE:"resize",START_RESIZE:"startresize",END_RESIZE:"endresize",TOUCH:"touch",START_TOUCH:"starttouch",END_TOUCH:"endtouch",PINCH:"pinch",START_PINCH:"startpinch",END_PINCH:"endpinch",IMGLOAD:"imgload"},_init:function(){var e=this;e.container=s(e.get("areaEl"));var t=e.image;t.onload=function(){e._build(),e._rejustSize(t.width,t.height,e.container.width(),e.container.height()),e._createSelection(),e._drawScene(),e._bind(),e._createPreview(),e.fire(e.event.IMGLOAD,e.getOriginalSize())},t.src=e.get("url")},_bind:function(){var e=this;e._unBind(),e.canvas.on("mousemove",e._handleHover,e),e.canvas.on("mousedown",e._handleMouseDown,e),s(document).on("mouseup",e._handleMouseUp,e),e.on("*Change",e._doAttrChange,e),e.get("touchable")&&e._bindTouch()},_unBind:function(){var e=this;s(document).detach("mousemove",e._handleMouseMove,e),e.canvas.detach("mousedown",e._handleMouseDown,e),s(document).detach("mouseup",e._handleMouseUp,e),e.detach("*Change",e._doAttrChange,e)},_doAttrChange:function(t){var n=this;e.each(t.attrName,function(e,i){var a=t.newVal[i];switch(e){case"initWidth":n.theSelection.set("w",a);break;case"initHeight":n.theSelection.set("h",a);break;case"initialXY":n.theSelection.set("x",a[0]),n.theSelection.set("y",a[1]);break;case"borderColor":case"maskColor":case"maskOpacity":case"cubesColor":case"resizable":case"minWidth":case"minHeight":case"ratio":n.theSelection.set(e,a)}})},_createPreview:function(){var t=this;e.one(t.get("previewEl"))&&(t.preview=new a({image:t.image,previewEl:t.get("previewEl"),viewHeight:t.get("viewHeight"),viewWidth:t.get("viewWidth")}),t.on("imgload resize drag",function(){var e=t.getCropCoords();t.preview.draw(e.x,e.y,e.w,e.h,e.r)}))},_createSelection:function(){var e=this;e.theSelection=new o({x:e.get("initialXY")[0],y:e.get("initialXY")[1],w:e.get("initWidth"),h:e.get("initHeight"),minWidth:e.get("minWidth"),minHeight:e.get("minHeight"),resizable:e.get("resizable"),borderColor:e.get("borderColor"),cubesColor:e.get("cubesColor"),maskColor:e.get("maskColor"),maskOpacity:e.get("maskOpacity"),constraint:[e.canvasW,e.canvasH],ratio:e.get("ratio")}),e.theSelection.on("*Change",function(){e._drawScene()}),e.theSelection.on("resize",function(t){e.fire(e.event.RESIZE,t)}),e.theSelection.on("startresize",function(t){e.fire(e.event.START_RESIZE,t)}),e.theSelection.on("endresize",function(t){e.fire(e.event.END_RESIZE,t)}),e.theSelection.on("drag",function(t){e.fire(e.event.DRAG,t)}),e.theSelection.on("startdrag",function(t){e.fire(e.event.START_DRAG,t)}),e.theSelection.on("enddrag",function(t){e.fire(e.event.END_DRAG,t)})},_build:function(){function e(e){return e.preventDefault(),!1}var t=this,n=t.get("areaWidth"),i=t.get("areaHeight");t.container.css({position:"relative",width:n||t.container.width(),height:i||t.container.height()}),t.canvas.on("selectstart mousedown",e),t.container.html("").append(t.canvas.css({position:"absolute"}))},_drawScene:function(){this.theSelection.draw(this.ctx,this.image)},_handleHover:function(e){var t=this,n=t.canvas.offset(),i=e.pageX-n.left,a=e.pageY-n.top,o=t.theSelection.registerPointPos(i,a);t.theSelection.hoverByCode(o),t._drawScene()},_handleMouseMove:function(e){var t=this;window.getSelection?window.getSelection().removeAllRanges():document.selection.empty();var n=t.canvas.offset(),i=Math.min(Math.max(e.pageX-n.left,0),t.canvasW),a=Math.min(Math.max(e.pageY-n.top,0),t.canvasH);t.theSelection.canMove()&&t.theSelection.move(i-t.iMouseX,a-t.iMouseY),t.get("resizable")&&t.theSelection.canResize()&&t.theSelection.resize(i,a),t._drawScene()},_handleMouseDown:function(e){var t=this,n=t.theSelection,i=t.canvas.offset(),a=t.iMouseX=e.pageX-i.left,o=t.iMouseY=e.pageY-i.top;n.set({px:n.get("x"),py:n.get("y"),pw:n.get("w"),ph:n.get("h")},{silent:!0});var h=n.registerPointPos(a,o);n.markByCode(h),s(document).on("mousemove",t._handleMouseMove,t)},_handleMouseUp:function(e){var t=this;t.theSelection.reset(),s(document).detach("mousemove",t._handleMouseMove,t),t.fire(t.event.END_DRAG,e),t.fire(t.event.END_RESIZE,e)},_bindTouch:function(){var e=this;e._unBindTouch(),e.canvas.on("touchstart",e._handleTouchStart,e),e.canvas.on("touchmove",e._handleTouchMove,e),e.canvas.on("touchend",e._handleTouchEnd,e),e.canvas.on("pinchStart",e._handlePinchStart,e),e.canvas.on("pinch",e._handlePinch,e),e.canvas.on("pinchEnd",e._handlePinchEnd,e)},_unBindTouch:function(){var e=this;e.canvas.detach("touchstart",e._handleTouchStart,e),e.canvas.detach("touchmove",e._handleTouchMove,e),e.canvas.detach("touchend",e._handleTouchEnd,e),e.canvas.detach("pinchStart",e._handlePinchStart,e),e.canvas.detach("pinch",e._handlePinch,e),e.canvas.detach("pinchEnd",e._handlePinchEnd,e)},_handleTouchStart:function(e){var t=this,n=e.targetTouches[0],i=t.theSelection,a=t.canvas.offset(),o=t.iMouseX=n.pageX-a.left,h=t.iMouseY=n.pageY-a.top;i.set({px:i.get("x"),py:i.get("y"),pw:i.get("w"),ph:i.get("h")});var c=i.registerPointPos(o,h);i.markByCode(c),t.fire(t.event.START_TOUCH,e)},_handleTouchMove:function(e){var t=this;if(1==e.targetTouches.length){e.preventDefault();var n=e.targetTouches[0],i=t.canvas.offset(),a=Math.min(Math.max(n.pageX-i.left,0),t.canvasW),o=Math.min(Math.max(n.pageY-i.top,0),t.canvasH);t.theSelection.canMove()&&t.theSelection.move(a-t.iMouseX,o-t.iMouseY),t.get("resizable")&&t.theSelection.canResize()&&t.theSelection.resize(a,o),t._drawScene(),t.fire(t.event.TOUCH,e)}},_handleTouchEnd:function(e){this._handleMouseUp(e),this.fire(self.event.END_TOUCH,e)},_handlePinchStart:function(e){this.pinchScale=e.scale,this.cropCoords=this.getCropCoords(),this.fire(self.event.START_PINCH,e)},_handlePinch:function(e){var t=this,n=e.scale,i=t.canvasW,a=t.canvasH;if(t.get("ratio")){var o=t.cropCoords.w/t.cropCoords.h;o>i/a?a=i/o:i=a*o}t.cropCoords.w*n>=t.get("minWidth")&&t.cropCoords.h*n>=t.get("minHeight")&&t.setCropCoords(Math.max(t.cropCoords.x-t.cropCoords.w*(n-1)/2,0),Math.max(t.cropCoords.y-t.cropCoords.h*(n-1)/2,0),Math.min(t.cropCoords.w*n,i),Math.min(t.cropCoords.h*n,a)),t.fire(t.event.PINCH,e)},_handlePinchEnd:function(e){this.pinchScale=null,this.cropCoords=null,this.fire(self.event.END_TOUCH,e)},_rejustSize:function(e,t,n,i){var a,o,h=this;e/n>t/i?(a=Math.min(n,e),o=a*t/e):(o=Math.min(i,t),a=o*e/t),h.canvas[0].width=h.canvasW=Math.floor(a),h.canvas[0].height=h.canvasH=Math.floor(o),h.canvas.css({top:Math.floor((h.container.height()-h.canvasH)/2),left:Math.floor((h.container.width()-h.canvasW)/2)})},render:function(){this._init()},reset:function(){this._init()},destroy:function(){this._unBind(),this.canvas.remove(),this.theSelection=null,this.preview&&this.preview.destroy()},setCropCoords:function(e,t,n,i){this.set({initialXY:[e,t],initWidth:n,initHeight:i})},getCropCoords:function(){return e.merge(this.theSelection.getInfo(),{url:this.get("url"),r:this.image.width/this.canvasW})},getOriginalSize:function(){return{width:this.image.width,height:this.image.height}},getDisplaySize:function(){return{width:this.canvasW,height:this.canvasH}},toString:function(e){return JSON.stringify(this.getCropCoords(),null,e||0)}},{ATTRS:{areaEl:{value:""},areaWidth:{value:0},areaHeight:{value:0},url:{value:""},initWidth:{value:100},initHeight:{value:100},resizable:{value:!0},ratio:{value:!1},minHeight:{value:10},minWidth:{value:10},initialXY:{value:[50,50]},borderColor:{value:"#fff"},cubesColor:{value:"#fff"},maskColor:{value:"#000"},maskOpacity:{value:"0.5"},previewEl:{value:""},viewHeight:{value:100},viewWidth:{value:100},touchable:{value:!0}}})});