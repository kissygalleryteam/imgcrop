KISSY.add("kg/imgcrop/2.0.0/lib/normal/imgcrop",["./resizable","./dragable","node","base","event","dom","json"],function(e,t,i,a){"use strict";var s=t("./resizable"),r=t("./dragable"),o=t("node"),n=t("base"),h=o.all,l=t("event"),g=t("dom"),d=t("json");a.exports=n.extend({initializer:function(){},_init:function(){var e=this;e._render(),e._bind()},_bind:function(){var e=this;e._unbind(),e.on("*Change",e._loadImage,e),l.on(e._tempImg,"load",e._onImgLoad,e)},_unbind:function(){var e=this;e.detach("*Change",e._loadImage,e),l.detach(e._tempImg,"load",e._onImgLoad,e)},_render:function(){var e=this;e.area=h(e.get("areaEl")).css("overflow","hidden").html(""),e.preview=h(e.get("previewEl")).html(""),e.area.css("position","relative"),e.wrap=h('<div class="crop-wrap">'),e.wrap.append(e._createDragEl()).appendTo(e.area),e.get("areaWidth")?e.area.width(e.get("areaWidth")):e.set("areaWidth",e.area.width()),e.get("areaHeight")?e.area.height(e.get("areaHeight")):e.set("areaHeight",e.area.height()),e._layBase=new Image,e._layCropper=new Image,e._tempImg=new Image,e.wrap.append(e._layBase).append(e._layCropper),e._setPreview(),e._loadImage()},_createDragEl:function(){var t=this,i=t.el=h('<div class="crop">');return t.get("resizable")&&(e.each(["lt","rt","rb","lb","t"],function(e){i.append(h('<div class="cubes cubes-'+e+'">'))}),i.all(".cubes").css({position:"absolute","background-color":t.get("cubesColor"),width:6,height:6,"font-size":0,"line-height":0}),i.all(".cubes-lt").css({left:-4,top:-4,cursor:"nw-resize"}),i.all(".cubes-rt").css({right:-4,top:-4,cursor:"ne-resize"}),i.all(".cubes-lb").css({left:-4,bottom:-4,cursor:"sw-resize"}),i.all(".cubes-rb").css({right:-4,bottom:-4,cursor:"se-resize"}),i.all(".cubes-t").hide()),i.css({position:"absolute",left:t.get("initialXY")[0],top:t.get("initialXY")[1],width:t.get("initWidth"),height:t.get("initHeight"),display:"none",cursor:"move",background:"url('#')",border:"1px solid "+t.get("borderColor")}),i},_loadImage:function(){var t=this,i=t.get("url"),a=i.indexOf("?")>-1?"&":"?";t._layBase.style.visibility=t._layCropper.style.visibility="hidden",t._tempImg.src=t._layBase.src=t._layCropper.src=i+a+"nocache="+e.guid(),t._view&&(t._view.src=t._tempImg.src)},_onImgLoad:function(){this._initStyle(),this._setImgSize(),this._setPos(),this._initDrag(),this._initResize()},_initDrag:function(){var e=this;e._drag=new r(e.el,{Max:!0,mxContainer:e.wrap,onstart:function(t){e.fire("dragstart",t)},onmove:function(t){e._setPos(),e.fire("drag",t)},onstop:function(t){e.fire("dragend",t)}})},_initResize:function(){var e=this;e.get("resizable")&&(e._resize=new s(e.el,{Max:!0,Min:!0,Scale:e.get("ratio"),minWidth:e.get("minWidth"),minHeight:e.get("minHeight"),mxContainer:e.wrap,onResize:function(t){e._setPos(),e.fire("resize",t)},onResizeStart:function(t){e.fire("resizestart",t)},onResizeEnd:function(t){e.fire("resizeend",t)}}))},_initStyle:function(){var e=this;e.wrap.css({position:"relative",overflow:"hidden",background:e.get("maskColor")}),e.el.css("z-index",200),g.css(e._layCropper,{zIndex:100,position:"absolute",top:0,left:0}),g.css(e._layBase,{position:"absolute",opacity:e.get("maskOpacity"),top:0,left:0})},_adjustPos:function(){var e=this,t=e._getPos(),i=e.wrap.width(),a=e.wrap.height();t.x+t.w>i&&e.el.width(i-t.x),t.y+t.h>a&&e.el.height(a-t.y)},_setPos:function(){var e=this;e.el.css("zoom",.5),e.el.css({zoom:1,display:"block"}),e._adjustPos();var t=e._getPos();e._layCropper.style.clip="rect("+t.y+"px "+(t.x+t.w)+"px "+(t.y+t.h)+"px "+t.x+"px)",e._view&&e._setPrePos()},_setPreview:function(){var t=this,i=e.one(t.get("previewEl"));i&&(t._view=new Image,t._view.style.position="absolute",i.append(t._view),i.css({position:"relative",overflow:"hidden"}))},_setPrePos:function(){var e=this,t=e._getPos(),i=e._getSize(t.w,t.h,e.get("viewWidth")||g.width(preWrap),e.get("viewHeight")||g.height(preWrap)),a=i.height/t.h,s=t.y*a,r=t.x*a;g.css(e._view,{width:e._layBase.width*a,height:e._layBase.height*a,top:-s,left:-r,clip:"rect("+s+"px "+(r+i.width)+"px "+(s+i.height)+"px "+r+"px)"})},_getSize:function(e,t,i,a){var s,r,o=1*e,n=1*t;return o/i>n/a?(s=i,r=s*n/o):(r=a,s=r*o/n),{width:s,height:r}},_setImgSize:function(){var e=this,t=e._getSize(e._tempImg.width,e._tempImg.height,e.get("areaWidth"),e.get("areaHeight"));return e._layBase.style.width=e._layCropper.style.width=t.width+"px",e._layBase.style.height=e._layCropper.style.height=t.height+"px",e.wrap.css({position:"absolute",width:t.width,height:t.height,top:(e.area.height()-t.height)/2,left:(e.area.width()-t.width)/2}),e._layBase.style.visibility=e._layCropper.style.visibility="visible",e.fire("imgload",{width:t.width,height:t.height}),t},_getPos:function(){return{y:parseFloat(this.el.css("top")),x:parseFloat(this.el.css("left")),w:parseFloat(this.el.css("width")),h:parseFloat(this.el.css("height"))}},getDisplaySize:function(){return this._getSize(this._tempImg.width,this._tempImg.height,this.get("areaWidth"),this.get("areaHeight"))},getOriginalSize:function(){return{width:parseInt(this._tempImg.width,10),height:parseInt(this._tempImg.height,10)}},getCropCoords:function(){var e=this._getPos(),t=parseInt(this._tempImg.width,10)/parseInt(this._layBase.width,10),i={y:e.y,x:e.x,w:e.w,h:e.h,r:t,url:this.get("url")};return i},setCropCoords:function(e,t,i,a){this.el.css({width:i,height:a,top:t,left:e}),this._setPos()},render:function(){this._init()},show:function(){this.area.show()},hide:function(){this.area.hide()},destroy:function(){l.remove(this.area),this.area.html(""),this.preview.html("");for(var e in this)this.hasOwnProperty(e)&&delete this[e]},reset:function(){this._init()},toString:function(){return d.stringify(this.getCropCoords())}},{ATTRS:{areaEl:{value:""},areaWidth:{value:0},areaHeight:{value:0},url:{value:""},initWidth:{value:100},initHeight:{value:100},resizable:{value:!0},ratio:{value:!1},maskOpacity:{value:.5},maskColor:{value:"#000"},borderColor:{value:"#fff"},cubesColor:{value:"#fff"},minHeight:{value:100},minWidth:{value:100},previewEl:{value:""},viewHeight:{value:300},viewWidth:{value:300},initialXY:{value:[50,50]}}})});